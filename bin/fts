#!/usr/bin/env bash
# fts CLI - Manage Flip The Script interactively

set -e

FTS_DIR="${FTS_DIR:-$HOME/flip_the_script}"
HINTS_FILE="$HOME/.fts_hints"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Print colored output
info() { echo -e "${BLUE}â„¹${NC} $*"; }
success() { echo -e "${GREEN}âœ“${NC} $*"; }
warn() { echo -e "${YELLOW}âš ${NC} $*"; }
error() { echo -e "${RED}âœ˜${NC} $*"; }

# Show usage
usage() {
  cat << EOF
fts - Manage Flip The Script interactively

Usage: fts <command>

Commands:
  install       Interactive installation with alias selection
  aliases       Browse and enable/disable aliases
  hint          Show a random productivity hint
  hints         Toggle learning hints on/off
  update        Pull latest changes and reload
  edit          Open Flip The Script in editor
  check         Verify setup and diagnose issues
  benchmark     Test shell startup performance

Examples:
  fts install      # First-time setup
  fts aliases      # Manage your aliases
  fts hint         # Learn something new
  fts check        # Troubleshoot issues
EOF
}

# Show a random hint
show_hint() {
  local hints=(
    "Use 'z <dirname>' instead of 'cd' - it learns your most-used directories"
    "Press Ctrl+R to fuzzy search your command history with fzf"
    "Type 'll' for a detailed file list with git status"
    "Use 'lt' to see a tree view of directories"
    "The 'bat' command (alias: c) shows syntax-highlighted file contents"
    "Try 'empty \"message\"' to create an empty git commit"
    "Use 'new branch-name' to create and checkout a git branch"
    "Press Ctrl+T to fuzzy find files in current directory"
    "Type '..' to go up one directory, '...' for two, '....' for three"
    "Use 'gla' to see a beautiful git log graph of all branches"
    "The 'port 3000' alias shows what's running on port 3000"
    "Type 'path' to see your PATH in a readable format"
    "Use 'reload' to restart your shell after config changes"
    "NVM lazy-loads automatically when you cd into a directory with .nvmrc"
  )

  local random_hint=${hints[$RANDOM % ${#hints[@]}]}
  echo -e "${CYAN}ðŸ’¡ Hint:${NC} $random_hint"
}

# Toggle hints on/off
toggle_hints() {
  if [[ -f "$HINTS_FILE" ]]; then
    rm "$HINTS_FILE"
    success "Learning hints disabled"
  else
    touch "$HINTS_FILE"
    success "Learning hints enabled - you'll see tips occasionally"
    show_hint
  fi
}

# Browse and manage aliases
manage_aliases() {
  echo -e "${BLUE}Available Alias Categories:${NC}\n"

  echo "1. Git aliases (gs, gd, ga, gc, gp, gl, etc.)"
  echo "2. Docker aliases (d, dc, dps, dex, etc.)"
  echo "3. Kubernetes aliases (k, kgp, kgs, kl, etc.)"
  echo "4. Safety aliases (rm -i, cp -i, mv -i)"
  echo "5. Modern CLI replacements (eza, bat)"
  echo "6. Navigation shortcuts (.., ..., -, z)"
  echo "7. Utility aliases (reload, path, ports, myip)"
  echo "8. Common typo fixes (sl, gti, claer)"
  echo ""
  echo "View current aliases: alias | grep <pattern>"
  echo "Add custom aliases to: ~/.zshrc.local"
}

# Check setup health
check_setup() {
  info "Checking Flip The Script setup...\n"

  local issues=0

  # Check symlinks
  if [[ -L "$HOME/.zshrc" ]]; then
    success "~/.zshrc is symlinked"
  else
    error "~/.zshrc is not a symlink"
    issues=$((issues + 1))
  fi

  if [[ -L "$HOME/.config/starship.toml" ]]; then
    success "starship.toml is symlinked"
  else
    error "starship.toml is not symlinked"
    issues=$((issues + 1))
  fi

  # Check plugins
  if [[ -d "$HOME/.zsh/zsh-autosuggestions" ]]; then
    success "zsh-autosuggestions installed"
  else
    error "zsh-autosuggestions missing"
    issues=$((issues + 1))
  fi

  if [[ -d "$HOME/.zsh/zsh-syntax-highlighting" ]]; then
    success "zsh-syntax-highlighting installed"
  else
    error "zsh-syntax-highlighting missing"
    issues=$((issues + 1))
  fi

  # Check tools
  local tools=(starship fzf zoxide eza bat)
  for tool in "${tools[@]}"; do
    if command -v "$tool" &> /dev/null; then
      success "$tool installed"
    else
      error "$tool not found"
      issues=$((issues + 1))
    fi
  done

  # Check Nerd Font
  if ls ~/Library/Fonts/*[Nn]erd* /Library/Fonts/*[Nn]erd* 2>/dev/null | grep -q .; then
    success "Nerd Font detected"
  else
    warn "Nerd Font not found - icons may not display"
  fi

  echo ""
  if [[ $issues -eq 0 ]]; then
    success "All checks passed! Your setup looks good."
  else
    error "Found $issues issue(s). Run 'fts install' to fix."
  fi
}

# Benchmark shell startup
benchmark_shell() {
  info "Benchmarking shell startup (10 runs)...\n"

  if command -v hyperfine &> /dev/null; then
    hyperfine --warmup 3 --runs 10 'zsh -i -c exit'
  else
    local total=0
    for i in {1..10}; do
      local time=$(command time -p zsh -i -c exit 2>&1 | grep real | awk '{print $2}')
      total=$(echo "$total + $time" | bc)
      echo "Run $i: ${time}s"
    done
    local avg=$(echo "scale=3; $total / 10" | bc)
    echo -e "\n${CYAN}Average: ${avg}s${NC}"

    if (( $(echo "$avg < 0.5" | bc -l) )); then
      success "Shell startup is fast!"
    else
      warn "Shell startup is slow. Check NVM lazy-loading and plugins."
    fi
  fi
}

# Main command router
case "${1:-}" in
  install)
    "$FTS_DIR/install.sh"
    ;;
  aliases)
    manage_aliases
    ;;
  hint)
    show_hint
    ;;
  hints)
    toggle_hints
    ;;
  update)
    info "Updating Flip The Script..."
    cd "$FTS_DIR"
    git pull
    success "Updated! Reload shell with: exec zsh"
    ;;
  edit)
    ${EDITOR:-code} "$FTS_DIR"
    ;;
  check)
    check_setup
    ;;
  benchmark)
    benchmark_shell
    ;;
  help|--help|-h)
    usage
    ;;
  *)
    usage
    exit 1
    ;;
esac
